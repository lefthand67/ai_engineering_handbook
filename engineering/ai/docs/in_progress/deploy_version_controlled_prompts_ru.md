# Пошаговое руководство по управлению версионированными AI prompt-ами

> Владелец: Вадим Рудаков, lefthand67@gmail.com

Пошаговая инструкция для разработчиков по управлению и деплою версионированных AI prompt-ов из репозитория, с глубоким пояснением рисков и лучших практик. 

## 1. Храните prompt-ы в системе контроля версий

- **Все prompt-ы (JSON-файлы) размещайте в Git-репозитории (например, GitHub, GitLab)**.  
  Пример: `/prompts/user_onboarding.json` в репозитории `ai-prompts`.
- Старайтесь делать структуру папок по агентам или функциям, документация схемы обязательна.

## 2. Используйте ветки для разработки

- **Для экспериментов и разработки создавайте отдельные ветки (`dev`, `feature-x`)**.  
  Пример: Разработчик открывает ветку `feature-rewrite-onboarding` для теста новых prompt-ов по онбордингу.
- Все merge request'ы проходят ревью, линтинг и валидацию схемы prompt-ов.

## 3. Для продакшн деплоя используйте только неизменяемые теги

- **НИКОГДА не запускайте продакшен-агентов с плавающих веток (`main`, `dev`) — используйте строго определённый тег (например, `v1.2.0`)**.
- При релизе всегда создавайте тег из протестированной и проверенной ветки.  
  Пример: После QA создаётся тег `v2.0.1` на `main`, агент получает prompt-ы по этому тегу.

## 4. Валидируйте и аудируйте prompt-ы перед релизом

- **Автоматизировано валидируйте структуру JSON prompt-ов и запускайте регрессионные тесты на каждом релизе**.
- Ведите changelog в репозитории — фиксируйте каждую правку, ссылку на ревью, результаты тестов.
- Пример: Блокировка создания тега `v2.0.2` из-за ошибок схемы prompt-а до полного исправления.

## 5. Загружайте prompt-ы агентами через CI/CD

- При старте агент через деплой-скрипт или CI/CD pipeline:
  - Скачивает prompt-ы из указанного тега в репозитории.
  - Локально кеширует prompt-ы для скорости и стабильности.
- Пример: Docker-агент клонирует prompt-ы по тегу `v2.0.1`, все контейнеры используют одну версию.

## 6. Мониторьте и делайте откаты при необходимости

- **В случае ошибок или багов откатывайте деплой на предыдущий стабильный тег, просто обновив конфиг**.
- Пример: Деплой сломался из-за опечатки — агент переключается на тег `v2.0.0`, баг чинится в ветке.

## Осторожности и лучшие практики

- **Никогда не используйте плавающие ветки для prod**: это может привести к незаметным регрессиям и неожиданным изменениям prompt-ов.
- **Используйте только теги для продакшн**: каждый релиз документируйте, фиксируйте changelog и результаты тестов.
- **Всё автоматизируйте**: CI/CD должен проверять prompt-ы, создавать теги, деплоить и откатывать.
- **Дисциплина по схеме**: обязательно валидируйте структуру JSON prompt-ов перед каждым релизом — некорректные prompt-ы могут сломать инференс и привести к багам.
- **Аудит и откат**: теги дают полноценную историю изменений и возможность мгновенного отката на стабильную версию.
- **Контроль доступа**: ограничьте доступ к репозиторию с prompt-ами, не храните в них secret-ы или credentials.

## Реальный пример рабочего процесса

1. Разработчик создаёт изменения в ветке `feature-tweak-welcome`.
2. После ревью и тестов изменения сливаются в `main`.
3. CI/CD валидирует prompt-ы и создаёт новый тег `v3.1.0`.
4. Конфиг агента обновляется на тег `v3.1.0`, все агенты забирают prompt-ы именно по этому тегу.
5. По фидбеку пользователей найден edge-case баг. Разработчик фиксит баг в ветке, выпускает тег `v3.1.1`.
6. В случае инцидента можно откатиться на тег `v3.1.0`, восстановив гарантированно рабочее состояние.

***

**Сводная таблица**

| Этап                   | Ветка/Тег       | Риск         | Лучшая практика                       |
|------------------------|-----------------|--------------|---------------------------------------|
| Разработка/эксперименты| Ветка (`dev`)   | Средний      | Ревью + линт + тесты                  |
| Продакшен деплой       | Тег (`vX.Y.Z`)  | Минимальный  | Иммутабильная версия, документация    |
| Откат                  | Тег (`vX.Y.Z-1`)| Нет          | Быстро и надёжно                      |

***

**Профилактика от эксперта:** Даже опытные команды иногда “проталкивают” мелкие фиксы прямо в `main`, что приводит к инцидентам или ML-деградации. Используйте только теги для продакшн, автоматизируйте проверки и релизы, чётко документируйте каждое изменение — это стандарт работы в топовых компаниях и быстром стартапе.
